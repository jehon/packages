#!/usr/bin/env bash

RESOLV="/var/run/resolvconf/resolv.conf"
RESOLVTMP="/tmp/resolv.conf.vpn.new"
RESOLVBAK="/tmp/resolv.conf.vpn.backup"

up() {
  if [ -e "$RESOLVBAK" ]; then
   rm "$RESOLV"
  else
    echo "***JH*** Taking a backup"
    mv "$RESOLV" "$RESOLVBAK"
  fi

  echo "***JH*** Generating $RESOLVTMP to forward to google"
  cat <<-EOF > "$RESOLVTMP"
# Generated by jh-dns-google
nameserver 8.8.8.8
EOF

  echo "***JH*** Moving dns file into $RESOLV"
  mv "$RESOLVTMP" "$RESOLV"
}


down() {
  if [ -r "$RESOLVBAK" ]
  then
    echo "***JH*** Rollback of vpn configuration"
    mv "$RESOLVBAK" "$RESOLV"
  else
    echo "***JH*** No $RESOLVBAK found"
  fi

}

echo "***JH*** Setting DNS to Google"

case "$1" in
  up)
    up
    ;;

  down)
    down
    ;;

  *)
    echo "Going live mode"
    up
    trap down EXIT
    echo "Awaiting your command, master (ctrl-c to quit)!"
    sleep 1d
    ;;
esac

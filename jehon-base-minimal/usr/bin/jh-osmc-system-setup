#!/usr/bin/env bash

OSMC_ENV="./osmc.env"
if [ -n "$1" ]; then
    OSMC_ENV="$1"
fi

# shellcheck source=/dev/null
. "$OSMC_ENV"

TARGET="/home/osmc/.kodi/userdata"
if [ -n "$2" ]; then
    TARGET="$2"
fi

if [ -z "$NAS_OSMC_USER" ]; then
    echo "Need a NAS_OSMC_USER in $OSMC_ENV" >&2
    exit 255
fi

if [ -z "$NAS_OSMC_PASS" ]; then
    echo "Need a NAS_OSMC_PASS in $OSMC_ENV" >&2
    exit 255
fi

if [ -z "$NAS_IP" ]; then
    echo "Need a NAS_IP in $OSMC_ENV" >&2
    exit 255
fi

cat >"$TARGET"/sources.xml <<EOC
<sources>
    <video>
        <default pathversion="1"></default>
        <source>
            <name>Auto-mounted drives</name>
            <path pathversion="1">/media/</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>Films (Fran√ßais)</name>
            <path pathversion="1">smb://$NAS_IP/video/films</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>Movies (English)</name>
            <path pathversion="1">smb://$NAS_IP/video/movies</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>Compositions</name>
            <path pathversion="1">smb://$NAS_OSMC_USER:$NAS_OSMC_PASS@$NAS_IP/photo/films/</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>Temporary</name>
            <path pathversion="1">smb://$NAS_IP/transferts/videos/</path>
            <allowsharing>true</allowsharing>
        </source>
    </video>
    <music>
        <default pathversion="1"></default>
        <source>
            <name>Auto-mounted drives</name>
            <path pathversion="1">/media/</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>music (synology)</name>
            <path>smb://$NAS_IP/music/</path>
            <allowsharing>true</allowsharing>
        </source>
    </music>
    <files>
        <default pathversion="1"></default>
    </files>
</sources>
EOC

cat >"$TARGET"/passwords.xml <<EOC
<passwords>
    <path>
        <from pathversion="1">smb://$NAS_IP</from>
        <to pathversion="1">smb://$NAS_OSMC_USER:$NAS_OSMC_PASS@$NAS_IP</to>
    </path>
</passwords>
EOC

cat >"$TARGET"/keymaps/zKeymap.xml <<EOC
<keymap>
	<!-- https://kodi.wiki/view/Window_IDs -->
	<!-- https://github.com/xbmc/xbmc/blob/master/system/keymaps/keyboard.xml -->
	<FullscreenVideo>
		<remote>
             <!-- red / green / yellow / blue -->
			<!-- https://kodi.wiki/view/CEC -->
			<!-- https://github.com/xbmc/xbmc/blob/master/system/keymaps/remote.xml -->
			<red>AudioNextLanguage</red>
			<!-- <green>ShowSubtitles</green> -->
			<!-- <yellow>NextSubtitle</yellow> -->
            <green>NextSubtitle</green>
			<yellow>SubtitleDelayMinus</yellow>
			<blue>SubtitleDelayPlus</blue>
		</remote>
	</FullscreenVideo>
</keymap>
EOC

# envsubst < "$SWD"/../lib/jehon/src/sources.xml > "$TARGET"/sources.xml
chown osmc.osmc "$TARGET"/sources.xml
chown osmc.osmc "$TARGET"/passwords.xml
chown osmc.osmc "$TARGET"/keymaps/zKeymap.xml

#!/usr/bin/env bash

# shellcheck disable=SC1091
. /etc/jehon/restricted/osmc.env

if [ -z "$NAS_OSMC_USER" ]; then
    echo "Need a NAS_OSMC_USER in /etc/jehon/restricted/osmc.env" >&2
    exit 255
fi

if [ -z "$NAS_OSMC_PASS" ]; then
    echo "Need a NAS_OSMC_PASS in /etc/jehon/restricted/osmc.env" >&2
    exit 255
fi

if [ -z "$NAS_IP" ]; then
    echo "Need a NAS_IP in /etc/jehon/restricted/osmc.env" >&2
    exit 255
fi

cat >/home/osmc/.kodi/userdata/sources.xml <<EOC
<sources>
    <video>
        <default pathversion="1"></default>
        <source>
            <name>Auto-mounted drives</name>
            <path pathversion="1">/media/</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>Films (Fran√ßais)</name>
            <path>smb://$NAS_IP/video/films</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>Movies (English)</name>
            <path>smb://$NAS_IP/video/movies</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>Compositions</name>
            <path>smb://$NAS_OSMC_USER:$NAS_OSMC_PASS@$NAS_IP/photo/films/</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>Temporary</name>
            <path>smb://$NAS_IP/transferts/videos/</path>
            <allowsharing>true</allowsharing>
        </source>
    </video>
    <music>
        <default pathversion="1"></default>
        <source>
            <name>Auto-mounted drives</name>
            <path pathversion="1">/media/</path>
            <allowsharing>true</allowsharing>
        </source>
        <source>
            <name>music (synology)</name>
            <path>smb://$NAS_IP/music/</path>
            <allowsharing>true</allowsharing>
        </source>
    </music>
    <files>
        <default pathversion="1"></default>
    </files>
</sources>
EOC

cat >/home/osmc/.kodi/userdata/passwords.xml <<EOC
<passwords>
    <path>
        <from pathversion="1">smb://$NAS_IP/transferts</from>
        <to pathversion="1">smb://$NAS_OSMC_USER:$NAS_OSMC_PASS/transferts/</to>
    </path>
    <path>
        <from pathversion="1">smb://$NAS_IP/video</from>
        <to pathversion="1">smb://$NAS_OSMC_USER:$NAS_OSMC_PASS/video/</to>
    </path>
    <path>
        <from pathversion="1">smb://$NAS_IP/music</from>
        <to pathversion="1">smb://$NAS_OSMC_USER:$NAS_OSMC_PASS/music/</to>
    </path>
</passwords>
EOC

cat >/home/osmc/.kodi/userdata/keymaps/zKeymap.xml <<EOC
<keymap>
	<!-- https://kodi.wiki/view/Window_IDs -->
	<!-- https://github.com/xbmc/xbmc/blob/master/system/keymaps/keyboard.xml -->
	<FullscreenVideo>
		<remote>
			<!-- https://kodi.wiki/view/CEC -->
			<!-- https://github.com/xbmc/xbmc/blob/master/system/keymaps/remote.xml -->
			<red>AudioNextLanguage</red>
			<green>ShowSubtitles</green>
			<yellow>NextSubtitle</yellow>
			<blue></blue>
		</remote>
	</FullscreenVideo>
</keymap>
EOC

# envsubst < "$SWD"/../lib/jehon/src/sources.xml > /home/osmc/.kodi/userdata/sources.xml
chown osmc.osmc /home/osmc/.kodi/userdata/sources.xml
chown osmc.osmc /home/osmc/.kodi/userdata/passwords.xml
chown osmc.osmc /home/osmc/.kodi/userdata/keymaps/zKeymap.xml
